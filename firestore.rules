<<<<<<< HEAD
/**
 * Firestore Security Rules for On-Campus Nutrition Tracker
 * 
 * Purpose: Server-side validation and authorization enforcement
 * Security Principles:
 * - Defense in Depth: Mirrors client-side validation for DoS protection
 * - Principle of Least Privilege: Users can only access their own data
 * - Authorization Gates: All writes require user authentication and ownership check
 * 
 * DRY (Don't Repeat Yourself): Validation constraints defined once:
 * - MAX_NAME_LENGTH = 100 characters (meal name, serving size)
 * - MAX_TEXT_LENGTH = 300 characters (notes/other info)
 * - MAX_CALORIES = 5000 per serving
 * - MAX_MACRO = 2000 grams (carbs, fat, protein)
 * 
 * These match src/utils/mealValidation.ts MEAL_CONSTRAINTS for consistency
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions for auth and validation (keeps DRY and clarity)
    function isAuthenticated() {
      return request.auth != null;
    }
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    // Meal validation aligned with client constraints
    function isValidMeal(data) {
      return data.keys().hasAll(['name','servingSize','calories','userId','createdAt'])
        && data.name is string && data.name.size() > 0 && data.name.size() <= 100
        && data.servingSize is string && data.servingSize.size() > 0 && data.servingSize.size() <= 100
        && data.calories is number && data.calories >= 0 && data.calories <= 5000
        && data.userId is string && data.userId.size() > 0
        && (data.createdAt is number || data.createdAt is timestamp)
        && (!('servingsHad' in data) || (data.servingsHad is number && data.servingsHad >= 0))
        && (!('totalCarbs' in data) || (data.totalCarbs is number && data.totalCarbs >= 0 && data.totalCarbs <= 2000))
        && (!('totalFat' in data) || (data.totalFat is number && data.totalFat >= 0 && data.totalFat <= 2000))
        && (!('protein' in data) || (data.protein is number && data.protein >= 0 && data.protein <= 2000))
        && (!('sodium' in data) || (data.sodium is number && data.sodium >= 0))
        && (!('sugars' in data) || (data.sugars is number && data.sugars >= 0))
        && (!('calcium' in data) || (data.calcium is number && data.calcium >= 0))
        && (!('iron' in data) || (data.iron is number && data.iron >= 0))
        && (!('fatCategories' in data) || (data.fatCategories is string && data.fatCategories.size() <= 100))
        && (!('vitamins' in data) || (data.vitamins is string && data.vitamins.size() <= 300))
        && (!('otherInfo' in data) || (data.otherInfo is string && data.otherInfo.size() <= 300));
    }

    // CWE-862: Missing Authorization - Enforce user-scoped access to weight collection
    // Documents in the 'weight' collection have 'owner' and 'userID' fields for backward compatibility
    // Only authenticated users can read/write their own weight entries
    match /weight/{weightId} {
      allow read: if isAuthenticated() && (isOwner(resource.data.owner) || isOwner(resource.data.userID));
      allow create: if isAuthenticated()
        && (request.auth.uid == request.resource.data.owner || request.auth.uid == request.resource.data.userID)
        && (request.resource.data.owner is string || request.resource.data.userID is string)
        && request.resource.data.date is string && request.resource.data.date.size() > 0
        && (request.resource.data.weightLb is number || request.resource.data.weightKg is number);
      allow update: if isAuthenticated()
        && (isOwner(resource.data.owner) || isOwner(resource.data.userID))
        && (request.resource.data.owner == resource.data.owner || !('owner' in request.resource.data))
        && (request.resource.data.userID == resource.data.userID || !('userID' in request.resource.data));
      allow delete: if isAuthenticated() && (isOwner(resource.data.owner) || isOwner(resource.data.userID));
    }
    
    // Helper function: Check if user owns the resource
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Helper function: Validate meal data structure and constraints
    // Returns true if all validation checks pass
    function isValidMeal(data) {
      // Required fields presence check
      return data.keys().hasAll(['name', 'servingSize', 'calories', 'userId', 'createdAt'])
        // Name validation: Required, max 100 chars (prevent DoS via oversized strings)
        && data.name is string
        && data.name.size() > 0
        && data.name.size() <= 100
        // Serving size validation: Required, max 100 chars
        && data.servingSize is string
        && data.servingSize.size() > 0
        && data.servingSize.size() <= 100
        // Calories validation: Required numeric, 0-5000 range (realistic bounds)
        && data.calories is number
        && data.calories >= 0
        && data.calories <= 5000
        // User ID validation: Must be string
        && data.userId is string
        && data.userId.size() > 0
        // Created timestamp validation: Must be numeric (milliseconds since epoch)
        && (data.createdAt is number || data.createdAt is timestamp)
        // Optional numeric fields: If present, must be valid numbers within realistic bounds
        && (!('servingsHad' in data) || (data.servingsHad is number && data.servingsHad >= 0))
        && (!('totalCarbs' in data) || (data.totalCarbs is number && data.totalCarbs >= 0 && data.totalCarbs <= 2000))
        && (!('totalFat' in data) || (data.totalFat is number && data.totalFat >= 0 && data.totalFat <= 2000))
        && (!('protein' in data) || (data.protein is number && data.protein >= 0 && data.protein <= 2000))
        && (!('sodium' in data) || (data.sodium is number && data.sodium >= 0))
        && (!('sugars' in data) || (data.sugars is number && data.sugars >= 0))
        && (!('calcium' in data) || (data.calcium is number && data.calcium >= 0))
        && (!('iron' in data) || (data.iron is number && data.iron >= 0))
        // Optional string fields: If present, must be valid strings within length limits
        && (!('fatCategories' in data) || (data.fatCategories is string && data.fatCategories.size() <= 100))
        && (!('vitamins' in data) || (data.vitamins is string && data.vitamins.size() <= 300))
        && (!('otherInfo' in data) || (data.otherInfo is string && data.otherInfo.size() <= 300));
    }
    
    // User documents: Store user preferences, meal history, favorites
    match /users/{userId} {
      // Users can only read/write their own document
      allow read, write: if isAuthenticated() && isOwner(userId);
      
      // Subcollections: All user data is private to the user
      match /{document=**} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
    }
    
    // Meals collection: Track user meal entries with nutrition data
    match /meals/{mealId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated()
        && request.auth.uid == request.resource.data.userId
        && isValidMeal(request.resource.data);
      allow update: if isOwner(resource.data.userId)
        && request.resource.data.userId == resource.data.userId
        && isValidMeal(request.resource.data);
      allow delete: if isOwner(resource.data.userId);
    }

    // CWE-862: Missing Authorization - Enforce user-scoped access to water collection
    // Documents in the 'water' collection have 'userId' field
    // Only authenticated users can read/write their own water intake logs
    match /water/{logId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated()
        && request.auth.uid == request.resource.data.userId
        && request.resource.data.userId is string
        && request.resource.data.amountMl is number
        && request.resource.data.amountMl >= 0 && request.resource.data.amountMl <= 10000
        && (request.resource.data.createdAt is number || request.resource.data.createdAt is timestamp);
      allow update: if isOwner(resource.data.userId)
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.amountMl is number
        && request.resource.data.amountMl >= 0 && request.resource.data.amountMl <= 10000;
      allow delete: if isOwner(resource.data.userId);
    }

    // CWE-862: Missing Authorization - Enforce user-scoped access to meal plans
    // Hierarchical structure: /mealPlans/{userId}/dates/{date}/meals/{mealId}
    // Only authenticated users can access their own meal plans
    match /mealPlans/{userId}/{document=**} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Public read access to restaurant sample data (shared across all users)
    match /restaurants_sample/{restaurantId} {
      allow read: if true;
      allow write: if false;
    }
    match /restaurants_sample/{restaurantId}/items/{itemId} {
      allow read: if true;
      allow write: if false;
    }
    // Some components may use 'menu' as the subcollection name
    match /restaurants_sample/{restaurantId}/menu/{menuItemId} {
      allow read: if true;
      allow write: if false;
    }

    // CWE-862: Missing Authorization - Enforce user-scoped access to user documents (goals, preferences, favorites)
    // Only authenticated users can read/write their own user profile and preferences
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    match /users/{userId}/{document=**} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Deny all other access by default (secure by default)
=======
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // CWE-862: Missing Authorization - Enforce user-scoped access to weight collection
    // Documents in the 'weight' collection have 'owner' and 'userID' fields for backward compatibility
    // Only authenticated users can read/write their own weight entries
    match /weight/{document=**} {
      allow read: if request.auth != null && 
        (resource.data.owner == request.auth.uid || resource.data.userID == request.auth.uid);
      allow write: if request.auth != null && 
        (resource.data.owner == request.auth.uid || resource.data.userID == request.auth.uid);
      allow create: if request.auth != null;
    }

    // CWE-862: Missing Authorization - Enforce user-scoped access to meals collection
    // Documents in the 'meals' collection have 'userId' field
    // Only authenticated users can read/write their own meal entries
    match /meals/{mealId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // CWE-862: Missing Authorization - Enforce user-scoped access to water collection
    // Documents in the 'water' collection have 'userId' field
    // Only authenticated users can read/write their own water intake logs
    match /water/{logId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // CWE-862: Missing Authorization - Enforce user-scoped access to meal plans
    // Hierarchical structure: /mealPlans/{userId}/dates/{date}/meals/{mealId}
    // Only authenticated users can access their own meal plans
    match /mealPlans/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Public read access to restaurant sample data (shared across all users)
    match /restaurants_sample/{restaurantId} {
      allow read: if true;
      allow write: if false; // Only admins can write (via Firebase Console/Admin SDK)
    }

    match /restaurants_sample/{restaurantId}/items/{itemId} {
      allow read: if true;
      allow write: if false;
    }

    // CWE-862: Missing Authorization - Enforce user-scoped access to user documents (goals, preferences, favorites)
    // Only authenticated users can read/write their own user profile and preferences
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Allow user to access subcollections under their user document
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // CWE-862: Missing Authorization - Deny all other access by default
>>>>>>> 06e2a65 (Add CWE-862 Handling, Incorporate Firebase tool-kit, and enforce LF line endings)
    match /{document=**} {
      allow read, write: if false;
    }
  }
<<<<<<< HEAD
}
=======
}
>>>>>>> 06e2a65 (Add CWE-862 Handling, Incorporate Firebase tool-kit, and enforce LF line endings)
